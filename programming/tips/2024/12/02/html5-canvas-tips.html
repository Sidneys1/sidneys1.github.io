<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">

	<link rel="preload" href="https://sidneys1.github.io/assets/OpenDyslexic3-Regular.otf" as="font" crossorigin="anonymous">
	<link rel="preload" href="https://sidneys1.github.io/assets/OpenDyslexicMono-Regular.otf" as="font" crossorigin="anonymous">
	<link rel="preload" href="https://sidneys1.github.io/assets/css/main.css" as="style" />

	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="onion-location"
		content="http://sidneys77crlfslcr7zmj3msmxchgnxhrxlp3p3kbaswo7twchjnicid.onion/programming/tips/2024/12/02/html5-canvas-tips.html" />
	<link rel="icon" type="image/png" sizes="16x16"
		href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYBAMAAAASWSDLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAwUExURU03LQsKCjRLXmBfW7hSE5xdMqNxTeGqSrKLX09qi5R9hHCnv7bDvaWgnfPWpvHt2OhtVZsAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAECSURBVCjPY5goCAQsjCDSjAFEiri4gChBEEdJ3KXcEcoRUmAvKWGEcZREytlhHEFFgVAQxQiWEYQARogBIKYQlLMbZJeQgKIgQxuT0umNQPbsiYoRDBlnlH+ClM49M2kZQ9ppIRBHefUZBQ6GjDvCn4AmMQFl2BhabJQ+CUpcYN5zRhEok6vwU5DvFeed0xPDGCJarf4YX4/VXaysmMaQmlb+/v37VxKFwgxhDKmhJc/r+xIEBQXCgDKhz/z+/3/AwGAcCuI8j+h5/y5Z0ArMuVf37t2JVYJv0zIY0oCc5w6CUgK/3ICc4BN1/949F1i7ICyDoS10bvi//89l/xqGdQAA2bZcXLL532IAAAAASUVORK5CYII=" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HTML5 Canvas Tips | Sidneys1.com on GitHub Pages</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="HTML5 Canvas Tips" />
<meta name="author" content="Sidneys1" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The &lt;canvas&gt; element may be the best thing to happen to HTML since &lt;marquee&gt;. I‚Äôve been using it a lot for various projects recently and thought it‚Äôd be nice to collect some of the tips and tricks I‚Äôve learned into once place." />
<meta property="og:description" content="The &lt;canvas&gt; element may be the best thing to happen to HTML since &lt;marquee&gt;. I‚Äôve been using it a lot for various projects recently and thought it‚Äôd be nice to collect some of the tips and tricks I‚Äôve learned into once place." />
<link rel="canonical" href="https://sidneys1.github.io/programming/tips/2024/12/02/html5-canvas-tips.html" />
<meta property="og:url" content="https://sidneys1.github.io/programming/tips/2024/12/02/html5-canvas-tips.html" />
<meta property="og:site_name" content="Sidneys1.com on GitHub Pages" />
<meta property="og:image" content="https://sidneys1.github.io/images/html5-canvas-tips/hero.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-02T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://sidneys1.github.io/images/html5-canvas-tips/hero.png" />
<meta property="twitter:title" content="HTML5 Canvas Tips" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sidneys1"},"dateModified":"2024-12-02T00:00:00-05:00","datePublished":"2024-12-02T00:00:00-05:00","description":"The &lt;canvas&gt; element may be the best thing to happen to HTML since &lt;marquee&gt;. I‚Äôve been using it a lot for various projects recently and thought it‚Äôd be nice to collect some of the tips and tricks I‚Äôve learned into once place.","headline":"HTML5 Canvas Tips","image":"https://sidneys1.github.io/images/html5-canvas-tips/hero.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://sidneys1.github.io/programming/tips/2024/12/02/html5-canvas-tips.html"},"url":"https://sidneys1.github.io/programming/tips/2024/12/02/html5-canvas-tips.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="https://sidneys1.github.io/assets/css/main.css">
	<link rel="stylesheet" href="https://sidneys1.github.io/hitcount.py.cgi?path=%2Fprogramming%2Ftips%2F2024%2F12%2F02%2Fhtml5-canvas-tips.html" fetchpriority="low" /><link type="application/atom+xml" rel="alternate" href="https://sidneys1.github.io/feed.xml" title="Sidneys1.com on GitHub Pages" /><script defer src="https://sidneys1.github.io/assets/mastodon_comments.js" onload="initComments()"></script><!-- KaTeX -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
		integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

	<!-- The loading of KaTeX is deferred to speed up page rendering -->
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
		integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
		crossorigin="anonymous"></script>

	<!-- To automatically render math in text elements, include the auto-render extension: -->
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
		integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
		onload="renderMathInElement(document.body);"></script>

	<script type="module">
		/*
		 * This code is only used for loading/saving preferences
		 * to/from `localstorage`. If scripts are disabled all
		 * the theming still works, they just won't persist. :^)
		 */

		// Definition of preferences. Individual toggles should be
		// `id`'d `${key}-${value}`.
		const PREFERENCES = {
			'color': ['blue', 'green', 'red'],
			'mode': ['auto', 'light', 'dark', 'black'],
			'align': ['left', 'justify'],
			'font': ['default', 'od'],
		};

		// Save preferences to `localstorage`.
		function savePreferences() {
			var p = {
			};

			Object.entries(PREFERENCES).forEach(([key, values]) => {
				p[key] = values.find(value =>
					document.getElementById(`${key}-${value}`).checked);
			});

			localStorage.setItem('preferences', JSON.stringify(p));
		};

		// Run at page load
		// document.addEventListener("DOMContentLoaded", function (_, __) {
		// Load preferences once.
		const p = JSON.parse(localStorage.getItem('preferences') || '{}');
		Object.entries(PREFERENCES).forEach(([key, values]) =>
			document.getElementById(`${key}-${p[key] || values[0]}`).checked = true);

		// Register change handlers.
		Object.entries(PREFERENCES).forEach(([key, values]) =>
			values.forEach(value =>
				document.getElementById(`${key}-${value}`).addEventListener('change', e =>
					savePreferences())));
		// });
	</script>
	<noscript><style> .jsonly { display: none } </style></noscript>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="https://sidneys1.github.io/">Sidneys1.com on GitHub Pages</a>

	<span class="coffee"><a title="Buy me a Coffee" href="https://ko-fi.com/sidneys1" target="_blank" rel="noreferrer">
    <svg class="svg-icon">
			<use xlink:href="/assets/coffee-cup-1.svg#coffee"></use>
    </svg>

	</a></span><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="https://sidneys1.github.io/tags.html">Tags</a><a class="page-link" href="https://sidneys1.github.io/categories.html">Categories</a><a class="page-link" href="https://sidneys1.github.io/series.html">Series</a></div>
      </nav></div>

</header>

<div id="theme-parent">
	<div id="theme-select">
		<fieldset id="color-select">
			<legend align="bottom">Accent</legend>
			<input id="color-blue" type="radio" name="color" value="blue" checked /><label for="color-blue" title="Blue">üíß</label>
			<input id="color-green" type="radio" name="color" value="green" /><label for="color-green" title="Green">üå≥</label>
			<input id="color-red" type="radio" name="color" value="red" /><label for="color-red" title="Red">‚ù§Ô∏è</label>
		</fieldset>
		<fieldset id="mode-select">
			<legend>mode</legend>
			<input id="mode-auto" type="radio" name="mode" value="auto" checked /><label for="mode-auto" title="Auto">ü™Ñ</label>
			<input id="mode-light" type="radio" name="mode" value="light" /><label for="mode-light" title="Light">‚òÄÔ∏è</label>
			<input id="mode-dark" type="radio" name="mode" value="dark" /><label for="mode-dark" title="Dark">üåï</label>
			<input id="mode-black" type="radio" name="mode" value="black" /><label for="mode-black" title="Black (AMOLED)">üåë</label>
		</fieldset>
		<fieldset id="align-select">
			<legend>Align</legend>
			<input id="align-left" type="radio" name="align" value="left" checked /><label for="align-left" title="Left">‚¨ÖÔ∏è</label>
			<input id="align-justify" type="radio" name="align" value="justify" /><label for="align-justify" title="Justify">‚ÜîÔ∏è</label>
		</fieldset>
		<fieldset id="font-select">
			<legend>Font</legend>
			<input id="font-default" type="radio" name="font" value="default" checked /><label for="font-default" style="font-family: system-ui;" title="System Font">Aa</label>
			<input id="font-od" type="radio" name="font" value="od" /><label for="font-od" style="font-family: opendyslexic;" title="OpenDyslexic">Od</label>
		</fieldset>
		<noscript title="JavaScript is disabled. Preferences can not be saved to browser local storage.">
			‚ÑπÔ∏è <em>Preferences can not be saved.</em>
		</noscript>
	</div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

	<header class="post-header">
		<h1 class="post-title p-name" itemprop="name headline">HTML5 Canvas Tips</h1>
		<h2 class="post-title p-name"></h1><p class="post-meta">
			<time class="dt-published" datetime="2024-12-02T00:00:00-05:00" itemprop="datePublished">Dec 2, 2024
			</time>‚Ä¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person">
				<span class="p-author h-card" itemprop="name">Sidneys1</span></span>&nbsp;‚Ä¢&nbsp;<a href="https://sidneys1.github.io/tags.html#programming" style="display: inline;"
				class="tag">programming</a>&nbsp;‚Ä¢&nbsp;<a href="https://sidneys1.github.io/tags.html#html5" style="display: inline;"
				class="tag">html5</a>&nbsp;‚Ä¢&nbsp;<a href="https://sidneys1.github.io/tags.html#canvas" style="display: inline;"
				class="tag">canvas</a>&nbsp;‚Ä¢&nbsp;<a href="https://sidneys1.github.io/tags.html#tips" style="display: inline;"
				class="tag">tips</a></p></header><div class="post-image"><img src="https://sidneys1.github.io/images/html5-canvas-tips/hero.png" style="box-shadow: none;"></div><!-- <div class="post-toc"> -->
	<ul id="toc" class="toc__list">
<li class="toc-entry toc-h2"><a href="#pixel-canvas">Pixel Canvas</a></li>
<li class="toc-entry toc-h2"><a href="#hi-dpi-canvas">HI-DPI Canvas</a></li>
<li class="toc-entry toc-h2"><a href="#cleartype-font-smoothing">ClearType Font Smoothing</a></li>
<li class="toc-entry toc-h2"><a href="#matching-background-colors-on-an-opaque-canvas">Matching Background Colors on an Opaque Canvas</a></li>
</ul>
	<!-- </div> -->

	<div class="post-content e-content" itemprop="articleBody">
		<p>The <code class="language-plaintext highlighter-rouge">&lt;canvas&gt;</code> element may be the best thing to happen to HTML since <code class="language-plaintext highlighter-rouge">&lt;marquee&gt;</code>. I‚Äôve been
<a href="https://github.com/Sidneys1/Merlin" target="_blank">using</a> it <a href="https://github.com/Sidneys1/Raina" target="_blank">a lot</a> for <a href="https://infosec.exchange/@Sidneys1/113562091539216937" target="_blank">various projects</a>
recently and thought it‚Äôd be nice to collect some of the tips and tricks I‚Äôve learned into once place.</p>

<!--more-->

<style>
canvas {
	align-self: center;
	justify-self: center;
	margin-bottom: 15px;
}
canvas:not(.no-shadow) {
	box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.highlight-4 {
	text-shadow: 0 0 3px #00000080;
}
</style>

<h2 id="pixel-canvas">Pixel Canvas</h2>

<p>If you‚Äôve used canvas at all you know that its <code class="language-plaintext highlighter-rouge">width="xxx"</code> and <code class="language-plaintext highlighter-rouge">height="xxx"</code> attributes define the dimensions of the
image the canvas represents, while you can use the <code class="language-plaintext highlighter-rouge">style="width: xxx; height: xxx;"</code> CSS properties to control the
size of the element on the page. If you‚Äôre trying to create a pixelated-style game, you can use the CSS to scale up a
relatively small canvas:</p>

<div style="display: grid; grid-template-columns: 1fr auto; gap: 1em;">

<div style="align-self: center;">

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">"pixelated-canvas"</span>
        <span class="na">width=</span><span class="s">"50"</span> <span class="na">height=</span><span class="s">"50"</span><span class="nt">&gt;&lt;/canvas&gt;</span>
</code></pre></div>    </div>

    <div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">canvas</span> <span class="p">{</span> <span class="nl">width</span><span class="p">:</span> <span class="m">300px</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span> <span class="m">300px</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">pixelated-canvas</span><span class="dl">'</span><span class="p">).</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">grey</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">rect</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">stroke</span><span class="p">();</span>
</code></pre></div>    </div>

  </div>

<canvas id="pixelated-canvas" width="50" height="50" style="width: 300px; height: 300px;"></canvas>
<script>
window.addEventListener('load', e => {
    const canvas = document.getElementById('pixelated-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) throw `Expected 'canvas', got '${canvas?.constructor.name}'`;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 0, 50, 50);
    ctx.rect(5, 5, 40, 40);
    ctx.strokeStyle = 'black';
    ctx.stroke();
});
</script>

<div style="grid-column:1/3;">
    <p>Well, isn‚Äôt that ugly! Thankfully we can fix it with the <code class="language-plaintext highlighter-rouge">image-rendering: pixelated</code> CSS property. Also note while
we‚Äôre here that the stroke borders two pixels. That‚Äôs because the point coordinates fall on the borders between pixels.
To overcome this, we‚Äôll also offset the coordinates by half a pixel.</p>
  </div>

<div style="align-self: center;">

    <div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">canvas</span> <span class="p">{</span> <span class="nl">width</span><span class="p">:</span> <span class="m">300px</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span> <span class="m">300px</span><span class="p">;</span>
         <span class="highlight-4"><span class="nl">image-rendering</span><span class="p">:</span> <span class="n">pixelated</span><span class="p">;</span></span> <span class="p">}</span>
</code></pre></div>    </div>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">rect</span><span class="p">(</span><span class="mf">5<span class="highlight-4">.5</span></span><span class="p">,</span> <span class="mf">5<span class="highlight-4">.5</span></span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">stroke</span><span class="p">();</span>
</code></pre></div>    </div>

  </div>

<canvas id="pixelated-canvas-2" width="50" height="50" style="width: 300px; height: 300px; image-rendering: pixelated;"></canvas>
<script>
window.addEventListener('load', e => {
    const canvas = document.getElementById('pixelated-canvas-2');
    if (!(canvas instanceof HTMLCanvasElement)) throw 'bla';
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 0, 50, 50);
    ctx.rect(5.5, 5.5, 40, 40);
    ctx.strokeStyle = 'black';
    ctx.stroke();
});
</script>

</div>

<h2 id="hi-dpi-canvas">HI-DPI Canvas</h2>

<p>Because the canvas element has a specific size in pixels, it is not DPI-aware. That is, if your operating system or
browser zoom is set to anything other than 100%, the number of physical screen pixels that represent each CSS pixel may
not be in a 1-to-1 ratio.</p>

<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1em;">

<div style="text-align: center; grid-column: 2/3;font-weight: bold;">Canvas</div><div style="text-align: center;font-weight: bold;">Zoomed 3x</div>

<div style="align-self: center;">

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This is the current pixel ratio of device pixels to CSS pixels. For example,</span>
<span class="c1">// a value of `1.5` would indicate that for every CSS pixel, there are 1.5</span>
<span class="c1">// device pixels (a scaling ratio of 150%).</span>
<span class="kd">const</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">devicePixelRatio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">hidpi-canvas</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">grey</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">moveTo</span><span class="p">(</span><span class="mf">50.5</span><span class="p">,</span> <span class="mf">105.5</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="mf">150.5</span><span class="p">,</span> <span class="mf">105.5</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">stroke</span><span class="p">();</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">20pt serif</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">fillText</span><span class="p">(</span><span class="s2">`Ratio: </span><span class="p">${(</span><span class="nx">ratio</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nf">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span><span class="s2">%`</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</code></pre></div>    </div>

  </div>

<canvas id="hidpi-canvas" width="200" height="200"></canvas>
<script>
window.addEventListener('load', e => {
    const ratio = window.devicePixelRatio || 1;
    const canvas = document.getElementById('hidpi-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) throw 'bla';
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 0, 200, 200);
    ctx.moveTo(50.5, 105.5);
    ctx.lineTo(150.5, 105.5);
    ctx.strokeStyle = 'black';
    ctx.stroke();
    ctx.font = '20pt serif';
    ctx.fillStyle = 'black';
    const text = `Ratio: ${(ratio*100).toFixed(0)}%`;
    const size = ctx.measureText(text);
    ctx.fillText(text, 100-(size.width / 2), 100);
});
</script>

<img style="align-self: center; margin-bottom: 15px;" src="https://sidneys1.github.io/images/html5-canvas-tips/bad-hi-dpi.png" />

<div style="grid-column: 1/4;">
    <p>Note how the text is blurry, and the line below it is as well, despite using our half a pixel offset trick from
<a href="#pixel-canvas">the previous section</a> (if your ratio is 100%, just consult the screenshot)? Let‚Äôs make some tweaks to
the canvas to work around this:</p>
  </div>

<div style="align-self: center;">
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="kd">const</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">devicePixelRatio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">hidpi-canvas</span><span class="dl">'</span><span class="p">);</span>
<span class="highlight-4"><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">}</span><span class="s2">px`</span><span class="p">;</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">}</span><span class="s2">px`</span><span class="p">;</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">*=</span> <span class="nx">ratio</span><span class="p">;</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">*=</span> <span class="nx">ratio</span><span class="p">;</span></span>
<span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">);</span>
<span class="highlight-4"><span class="nx">ctx</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="nx">ratio</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">);</span></span>
<span class="c1">// ...</span></code></pre></div>    </div>
</div>

<canvas id="hidpi-canvas-2" width="200" height="200"></canvas>
<script>
window.addEventListener('load', e => {
    const ratio = window.devicePixelRatio || 1;
    const canvas = document.getElementById('hidpi-canvas-2');
    if (!(canvas instanceof HTMLCanvasElement)) throw 'bla';
    canvas.style.width = `${canvas.width}px`;
    canvas.style.height = `${canvas.height}px`;
    canvas.width *= ratio;
    canvas.height *= ratio;
    const ctx = canvas.getContext('2d');
    ctx.scale(ratio, ratio);
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 0, 200, 200);
    ctx.moveTo(50.5, 105.5);
    ctx.lineTo(150.5, 105.5);
    ctx.strokeStyle = 'black';
    ctx.stroke();
    ctx.font = '20pt serif';
    ctx.fillStyle = 'black';
    const text = `Ratio: ${(ratio*100).toFixed(0)}%`;
    const size = ctx.measureText(text);
    ctx.fillText(text, 100-(size.width / 2), 100);
});
</script>

<img style="align-self: center; margin-bottom: 15px;" src="https://sidneys1.github.io/images/html5-canvas-tips/good-hi-dpi.png" />

</div>

<h2 id="cleartype-font-smoothing">ClearType Font Smoothing</h2>

<p>Riding off our last example, let‚Äôs make the text rendering <em>even smoother</em>. If the browser knows that canvas text will
be rendered against a set color, it will use <a href="https://en.wikipedia.org/wiki/Subpixel_rendering" target="_blank">subpixel rendering</a> (aka ClearType). To do this, we
need to use an opaque canvas, created by passing some options to the canvas‚Äô <code class="language-plaintext highlighter-rouge">getContext</code> function.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">cleartype-canvas</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">,</span> <span class="highlight-4"><span class="p">{</span><span class="na">alpha</span><span class="p">:</span> <span class="kc">false</span><span class="p">}</span></span><span class="p">);</span>
</code></pre></div></div>

<div style="display: grid; grid-template-columns: auto 1fr auto; gap: 0 1em;">

<div style="grid-column: 3; font-weight: bold;text-align: center;">Zoomed 4x</div>

<div style="align-self: center; font-style:italic; justify-self: end;">Browser-rendered text:</div>

<div id="hello-world" style="align-self: center; text-align: center;color: grey;">Hello, World!</div>

<img style="align-self: center; margin-bottom: 15px;" src="https://sidneys1.github.io/images/html5-canvas-tips/browser-text.png" />

<div style="align-self: center;font-style:italic; justify-self: end;">Default canvas-rendered text (with HI-DPI fix):</div>
<canvas id="no-cleartype-canvas" class="no-shadow" width="200" height="50"></canvas>
<script>
window.addEventListener('load', e => {
    const helloWorld = document.getElementById('hello-world');
    if (!(helloWorld instanceof HTMLDivElement)) throw 'Expected div!';
    const font = window.getComputedStyle(helloWorld).font;
    const ratio = window.devicePixelRatio || 1;
    const canvas = document.getElementById('no-cleartype-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) throw 'bla';
    canvas.style.width = `${canvas.width}px`;
    canvas.style.height = `${canvas.height}px`;
    canvas.width *= ratio;
    canvas.height *= ratio;
    const ctx = canvas.getContext('2d');
    ctx.scale(ratio, ratio);
    ctx.font = font;
    ctx.fillStyle = 'grey';
    const text = 'Hello, World!';
    const size = ctx.measureText(text);
    ctx.fillText(text, 100-(size.width / 2), 40);
});
</script>
<img style="align-self: center; margin-bottom: 15px;" src="https://sidneys1.github.io/images/html5-canvas-tips/bad-canvas-text.png" />

<div style="align-self: center;font-style:italic; justify-self: end;">Canvas-rendered text with HI-DPI and ClearType fix:</div>
<canvas id="cleartype-canvas" class="no-shadow" width="200" height="50"></canvas>
<script>
function getBgColor(element) {
    if (element === undefined) throw "Reached end of tree...";
    const bg = window.getComputedStyle(element).background;
    if (bg === 'none') return getBgColor(element.parentElement);
    return [bg, element];
}
function redraw(ctx, bg) {
    const helloWorld = document.getElementById('hello-world');
    if (!(helloWorld instanceof HTMLDivElement)) throw 'Expected div!';
    const font = window.getComputedStyle(helloWorld).font;
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, 200, 50);
    ctx.font = font;
    ctx.fillStyle = 'grey';
    const text = 'Hello, World!';
    const size = ctx.measureText(text);
    ctx.fillText(text, 100-(size.width / 2), 40);
}
window.addEventListener('load', e => {
    const ratio = window.devicePixelRatio || 1;
    const canvas = document.getElementById('cleartype-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) throw 'bla';
    canvas.style.width = `${canvas.width}px`;
    canvas.style.height = `${canvas.height}px`;
    canvas.width *= ratio;
    canvas.height *= ratio;
    const ctx = canvas.getContext('2d', {alpha: false});
	ctx.scale(ratio, ratio);
    const [bg, element] = getBgColor(canvas);
    element.addEventListener('change', e => {
        const [bg2, element] = getBgColor(canvas);
        redraw(ctx, bg2);
    });
    redraw(ctx, bg);
});
</script>

<img style="align-self: center; margin-bottom: 15px;" src="https://sidneys1.github.io/images/html5-canvas-tips/good-canvas-text.png" />
</div>

<h2 id="matching-background-colors-on-an-opaque-canvas">Matching Background Colors on an Opaque Canvas</h2>

<p>When using an opaque canvas, the default fill color when initialized or when calling <code class="language-plaintext highlighter-rouge">ctx.clearRect(...)</code> is always
<code class="language-plaintext highlighter-rouge">#000</code>. If we want the canvas fill to match our page (assuming it‚Äôs a solid color), we can get the color with this
simple function:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns the background color of the nearest ancestor that is not `none`.
 * @param {HTMLElement} element
 * @returns {string}
 */</span>
<span class="kd">function</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">throw</span> <span class="dl">"</span><span class="s2">Reached end of tree...</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">bg</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">background</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">bg</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">bg</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ...later...</span>
<span class="kd">const</span> <span class="nx">bg</span> <span class="o">=</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nf">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</code></pre></div></div>

<p>If the background can change (e.g., when entering or leaving dark mode) you can subscribe to change events like so:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns the background color of the nearest ancestor that is not `none`.
 * @param {HTMLElement} element
 * @returns {[string, HTMLElement]}
 */</span>
<span class="kd">function</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">throw</span> <span class="dl">"</span><span class="s2">Reached end of tree...</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">bg</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">background</span><span class="p">;</span>
	<span class="c1">// Note that we've changed this to return the element as well as the color.</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">bg</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="nx">bg</span><span class="p">,</span> <span class="nx">element</span><span class="p">];</span>
    <span class="k">return</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ...later...</span>
<span class="kd">function</span> <span class="nf">redraw</span><span class="p">(</span><span class="nx">bg_color</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">bg_color</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="p">[</span><span class="nx">bg</span><span class="p">,</span> <span class="nx">element</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getBgColor</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
<span class="nf">redraw</span><span class="p">(</span><span class="nx">bg</span><span class="p">);</span>
<span class="nx">element</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="nf">redraw</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nf">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">background</span><span class="p">));</span>
</code></pre></div></div>

	</div>

	<hr>

	<div class="donate">
		Like what you read?
		<a href="https://ko-fi.com/sidneys1" target="_blank" rel="noreferrer">
			Consider buying me a coffee.
		</a>
		<br/>
		<a title="Consider buying me a coffee." href="https://ko-fi.com/sidneys1" target="_blank" rel="noreferrer" style="display: inline-block;">
			<!-- <img height="50px" title="Buy me a Coffee" src="https://sidneys1.github.io/assets/coffee-cup-1.svg"/> -->
			<svg class="svg-icon grey">
				<use xlink:href="/assets/coffee-cup-1.svg#coffee"></use>
			</svg>
		</a>
	</div><p class="todo">Comments only visible under <code>site.mode == "www" or site.mode == "local-prod"</code>!</p><a class="u-url" href="https://sidneys1.github.io/programming/tips/2024/12/02/html5-canvas-tips.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
	<data class="u-url" href="https://sidneys1.github.io/"></data>

	<div class="wrapper">

		<div class="footer-col-wrapper">
			<div class="footer-col">
				<ul class="contact-list">
					<li class="p-name">Contact</li><li>
	<a rel="me" href="mailto:Sidneys1@proton.me" target="_blank" title="ProtonMail">
		<svg class="svg-icon">
			<use xlink:href="/assets/minima-social-icons.svg#protonmail"></use>
		</svg>
		<span>ProtonMail</span>
	</a>
</li>
<li>
	<a rel="me" href="mailto:admin@sSidneys1.com" target="_blank" title="Site Support">
		<svg class="svg-icon">
			<use xlink:href="/assets/minima-social-icons.svg#email"></use>
		</svg>
		<span>Site Support</span>
	</a>
</li>
<li>
	<a rel="me" href="https://matrix.to/#/@sidneys1:matrix.org" target="_blank" title="Matrix Chat">
		<svg class="svg-icon">
			<use xlink:href="/assets/minima-social-icons.svg#matrix"></use>
		</svg>
		<span>Matrix Chat</span>
	</a>
</li>
<li>
	<a rel="me" href="https://simplex.chat/contact#/?v=1-2&smp=smp%3A%2F%2FSkIkI6EPd2D63F4xFKfHk7I1UGZVNn6k1QWZ5rcyr6w%3D%40smp9.simplex.im%2FQwoc8ketLODmigLCuVhCt8Eio_ruJFnj%23%2F%3Fv%3D1-2%26dh%3DMCowBQYDK2VuAyEAtEpK9f8ocpGt_MYmDVj0FrCIorSk7PSIVI-BmxLHUHE%253D%26srv%3Djssqzccmrcws6bhmn77vgmhfjmhwlyr3u7puw4erkyoosywgl67slqqd.onion" target="_blank" title="SimpleX Chat">
		<svg class="svg-icon">
			<use xlink:href="/assets/minima-social-icons.svg#simplex"></use>
		</svg>
		<span>SimpleX Chat</span>
	</a>
</li>
</ul>
			</div>
			<div class="footer-col site-desc">
				<p>A home for all my ramblings on subjects such as programming, cybersecurity, photography, videography, video games, and whatever else I see fit.</p><hr>
			</div>
			<div class="footer-col">
				<ul class="access-list">
					<li class="p-name">Alternative Access</li><li>
	<a rel="me" href="http://sidneys77crlfslcr7zmj3msmxchgnxhrxlp3p3kbaswo7twchjnicid.onion" target="_blank" title="Tor">
		<span>Tor</span>
		<svg class="svg-icon grey">
			<use xlink:href="/assets/minima-social-icons.svg#tor"></use>
		</svg>
	</a>
</li>
<li>
	<a rel="me" href="https://sidneys1-com.ipns.cf-ipfs.com/" target="_blank" title="IPFS (Cloudflare)">
		<span>IPFS (Cloudflare)</span>
		<svg class="svg-icon grey">
			<use xlink:href="/assets/minima-social-icons.svg#ipfs"></use>
		</svg>
	</a>
</li>
<li>
	<a rel="me" href="https://sidneys1.github.io" target="_blank" title="GitHub Pages">
		<span>GitHub Pages</span>
		<svg class="svg-icon grey">
			<use xlink:href="/assets/minima-social-icons.svg#github"></use>
		</svg>
	</a>
</li>
</ul>
			</div>
			<div class="footer-col">
				<div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/Sidneys1" target="_blank" title="GitHub">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a href="/feed.xml" target="_blank" title="Sidneys1.com RSS Feed">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.youtube.com/channel/UCoCiN9Yd8ifG1PeVb6wY0jg" target="_blank" title="YouTube Channel">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#youtube"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://infosec.exchange/@Sidneys1" target="_blank" title="Mastodon (infosec.exchange)">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#mastodon"></use>
    </svg>
  </a>
</li>
</ul>
</div>
			</div>
		</div>

	</div>

</footer>
</body>

</html>
